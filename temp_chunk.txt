function CreateTaskModal({ visible, onClose, lead }: { visible: boolean; onClose: () => void; lead: LeadItem | null }) {
  const [title, setTitle] = useState<string>(lead ? `Follow up: ${lead.name}` : '');
  const [dueDate, setDueDate] = useState<string>('');
  const [notes, setNotes] = useState<string>('');
  const [files, setFiles] = useState<Attachment[]>([]);

  useEffect(() => {
    if (visible) {
      setTitle(lead ? `Follow up: ${lead.name}` : '');
      setDueDate('');
      setNotes('');
      setFiles([]);
    }
  }, [visible, lead]);

  const onAddAttachment = async () => {
    try {
      const res = await launchImageLibrary({ mediaType: 'mixed', selectionLimit: 1 });
      const asset: Asset | undefined = res?.assets?.[0];
      if (!asset?.uri) return;
      const next: Attachment = { uri: asset.uri, name: asset.fileName || 'attachment', type: asset.type || undefined, fileSize: asset.fileSize };
      setFiles((prev) => [...prev, next]);
    } catch {}
  };

  return (
    <Modal visible={visible} transparent animationType="slide" onRequestClose={onClose}>
      <View style={styles.modalBackdrop}>
        <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : undefined} style={styles.modalCard}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>New Task</Text>
            <Pressable onPress={onClose} accessibilityRole="button"><Ionicons name="close" size={20} color="#111827" /></Pressable>
          </View>
          <Text style={styles.modalHint} numberOfLines={1}>For: {lead?.name || '-'}</Text>
          <View style={styles.modalField}> 
            <Text style={styles.modalLabel}>Title</Text>
            <TextInput value={title} onChangeText={setTitle} placeholder="Task title" style={styles.modalInput} />
          </View>
          <View style={styles.modalField}> 
            <Text style={styles.modalLabel}>Due Date</Text>
            <TextInput value={dueDate} onChangeText={setDueDate} placeholder="YYYY-MM-DD" style={styles.modalInput} />
          </View>
          <View style={styles.modalField}> 
            <Text style={styles.modalLabel}>Notes</Text>
            <TextInput value={notes} onChangeText={setNotes} placeholder="Notes (optional)" style={[styles.modalInput, { height: 72 }]} multiline />
          </View>
          <View style={styles.modalField}>
            <Text style={styles.modalLabel}>Attachments</Text>
            <View style={styles.attachRow}>
              {files.map((f, idx) => (
                <View key={`${f.uri}-${idx}`} style={styles.attachChip}>
                  <Ionicons name="attach" size={12} color="#111827" />
                  <Text style={styles.attachChipText} numberOfLines={1}>{f.name || `File ${idx+1}`}</Text>
                  <Pressable onPress={() => setFiles(files.filter((_, i) => i !== idx))} style={{ marginLeft: 6 }}>
                    <Ionicons name="close" size={12} color="#6b7280" />
                  </Pressable>
                </View>
              ))}
              <Pressable onPress={onAddAttachment} style={styles.attachAddBtn} accessibilityRole="button">
                <Ionicons name="add" size={12} color="#111827" />
                <Text style={styles.attachAddText}>Add</Text>
              </Pressable>
            </View>
          </View>
          <View style={styles.modalActions}>
            <Pressable style={[styles.modalBtn, styles.modalBtnGhost]} onPress={onClose}><Text style={styles.modalBtnGhostText}>Cancel</Text></Pressable>
            <Pressable style={[styles.modalBtn, styles.modalBtnPrimary]} onPress={onClose}><Text style={styles.modalBtnPrimaryText}>Create</Text></Pressable>
          </View>
        </KeyboardAvoidingView>
      </View>
    </Modal>
  );
}


